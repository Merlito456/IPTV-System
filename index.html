<script>
  let hls = null, ytPlayer = null, ytApiLoaded = false;

  function showOverlay(txt) { $('#overlay').text(txt).show(); }
  function hideOverlay() { $('#overlay').hide(); }
  function showNoise(v) { $('#noise').toggle(v); }

  function clearVideo() {
    if (hls) { hls.destroy(); hls = null; }
    if (ytPlayer && ytPlayer.destroy) { ytPlayer.destroy(); ytPlayer = null; }
    $('#video-area').find('video, #yt-player').remove();
  }

  function playIPTV(src) {
    clearVideo(); showOverlay('Loading...'); showNoise(false);
    const video = $('<video autoplay muted controls playsinline>').appendTo('#video-area');
    if (Hls.isSupported()) {
      hls = new Hls({ enableWorker: true, lowLatencyMode: true });
      hls.loadSource(src); hls.attachMedia(video[0]);
      hls.on(Hls.Events.MANIFEST_PARSED, () => { video[0].play(); hideOverlay(); });
      hls.on(Hls.Events.ERROR, (_, d) => { if (d.fatal) showOverlay('Playback error'); });
    } else if (video[0].canPlayType('application/vnd.apple.mpegurl')) {
      video[0].src = src;
      video.on('loadedmetadata', () => { video[0].play(); hideOverlay(); });
    } else {
      showOverlay('Unsupported format');
    }
  }

  function loadYouTubeVideoId(videoId) {
    clearVideo(); showOverlay('Loading YT...'); showNoise(false);
    if (!ytApiLoaded) {
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      document.body.appendChild(tag);
      ytApiLoaded = true;
    }
    window.onYouTubeIframeAPIReady = () => {
      $('<div id="yt-player">').appendTo('#video-area');
      ytPlayer = new YT.Player('yt-player', {
        height: '100%', width: '100%', videoId: videoId,
        playerVars: { autoplay: 1, controls: 1, modestbranding: 1, rel: 0, playsinline: 1 },
        events: {
          onReady: e => { e.target.playVideo(); hideOverlay(); },
          onError: () => showOverlay('YT Playback error')
        }
      });
    };
  }

  function autoLoadYouTubeLive(channelId) {
    fetch(`http://vipstreaming.zya.me/get_youtube_live.php?channel_id=${channelId}`)
      .then(r => r.json())
      .then(data => {
        if (data.liveVideoId) {
          loadYouTubeVideoId(data.liveVideoId);
        } else {
          showOverlay('No YouTube live stream currently');
          showNoise(true);
        }
      })
      .catch(() => {
        showOverlay('Failed to check YouTube live status');
        showNoise(true);
      });
  }

  function loadChannels() {
    fetch('channels.json')
      .then(r => r.json())
      .then(d => {
        const iptv = $('#iptv-list').empty();
        d.iptv.forEach(c => iptv.append(`<div class="channel-item" data-type="iptv" data-stream="${encodeURI(c.stream_url)}">${c.name}</div>`));
        const yt = $('#youtube-list').empty();
        d.youtube.forEach(c => yt.append(`<div class="channel-item" data-type="youtube" data-youtubeid="${c.youtube_channel_id}">${c.name}</div>`));
      })
      .catch(() => alert('Failed loading channels'));
  }

  $('#channel-panel').on('click', '.channel-item', function () {
    const type = $(this).data('type'), stream = $(this).data('stream'), yid = $(this).data('youtubeid');
    if (type === 'iptv') playIPTV(stream);
    else autoLoadYouTubeLive(yid);
  });

  $('.section-header').click(function () {
    $('#' + $(this).data('target')).toggleClass('expanded');
  });

  $('#toggle-panel').click(() => $('#channel-panel').toggleClass('hidden'));

  // üëá This is the ONLY part you change: provide default channel to autoplay on load
  window.onload = () => {
    showOverlay('Checking for YouTube live stream...');
    showNoise(true);
    autoLoadYouTubeLive('UCxxxxxxxxxxxx'); // üîÅ Replace with your default channel ID
    loadChannels();
  };
</script>